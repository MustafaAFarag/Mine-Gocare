<p-toast position="top-left" styleClass="black-text-toast"></p-toast>

<div
  class="search-overlay"
  (click)="closeSearchPanel()"
  id="search-overlay"
></div>
<div class="search-container bg-white p-4 shadow-md">
  <div class="mb-4 flex items-center justify-between gap-4">
    <h2 class="text-xl font-semibold">{{ "search.title" | translate }}</h2>
    <button
      (click)="closeSearchPanel()"
      id="search-close-button"
      class="p-2 text-gray-500 hover:text-gray-700"
    >
      <i class="ri-close-line text-2xl"></i>
    </button>
  </div>

  <div class="relative mb-4">
    <div class="relative">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        id="search-input"
        (ngModelChange)="onSearch()"
        placeholder="{{ 'search.placeholder' | translate }}"
        class="w-full rounded-md border border-gray-300 bg-white p-3 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500"
        autofocus
      />
      <i
        class="ri-search-line absolute text-gray-400"
        [class.right-3]="translateService.currentLang === 'en'"
        [class.left-3]="translateService.currentLang === 'ar'"
        [class.top-3]="true"
      ></i>
    </div>
  </div>

  <div class="search-results">
    @if (isLoading) {
      <div class="flex items-center justify-center py-8">
        <app-loading></app-loading>
      </div>
    } @else if (filteredProducts.length === 0) {
      <div class="py-8 text-center text-gray-500">
        @if (searchTerm.trim() === "") {
          {{ "search.startSearching" | translate }}
        } @else {
          {{ "search.noResults" | translate }}
        }
      </div>
    } @else {
      <div class="grid grid-cols-1 gap-4">
        @for (product of filteredProducts; track product.productId) {
          <div
            class="flex flex-col items-start justify-between gap-4 rounded-md p-3 transition-colors hover:bg-gray-50 sm:flex-row sm:items-center"
          >
            <a
              [id]="'search-product-link-' + product.productId"
              [routerLink]="[
                '/product-details',
                product.productId,
                product.variantId,
              ]"
              (click)="closeSearchPanel()"
              class="flex w-full items-start gap-4 sm:w-auto sm:flex-1"
            >
              <img
                [src]="getFullImageUrl(product.mainImageUrl)"
                [alt]="product.name[getCurrentLang()]"
                class="h-16 w-16 flex-shrink-0 rounded-md object-cover"
              />
              <div class="flex min-w-0 flex-1 flex-col gap-1">
                <h3 class="line-clamp-2 font-medium">
                  {{ product.name[getCurrentLang()] }}
                </h3>
                <p class="truncate text-sm text-gray-500">
                  {{ product.brand[getCurrentLang()] }}
                </p>
                <div class="flex flex-wrap items-center gap-2">
                  <p class="font-medium text-hover-color">
                    {{ product.priceAfterDiscount }}
                    {{ product.currency.name[getCurrentLang()] }}
                  </p>
                  @if (
                    product.priceAfterDiscount !== product.priceBeforeDiscount
                  ) {
                    <p class="text-sm text-gray-500 line-through">
                      {{ product.priceBeforeDiscount }}
                      {{ product.currency.name[getCurrentLang()] }}
                    </p>
                    <p class="text-sm font-medium text-hover-color">
                      {{ product.discountPercentage.toFixed(2) }}% off
                    </p>
                  }
                </div>
              </div>
            </a>
            <div
              class="flex w-full justify-end gap-2 sm:w-auto sm:flex-shrink-0"
            >
              <button
                (click)="toggleWishlist(product)"
                [id]="'search-wishlist-button-' + product.productId"
                class="flex flex-1 items-center justify-center rounded-md border border-gray-300 p-2 text-gray-600 hover:bg-gray-100 sm:flex-none"
                [title]="
                  isInWishlist(product)
                    ? 'Remove from Wishlist'
                    : 'Add to Wishlist'
                "
              >
                <i
                  [class]="
                    isInWishlist(product)
                      ? 'ri-heart-fill text-red-500'
                      : 'ri-heart-line'
                  "
                ></i>
              </button>
              <button
                (click)="addToCart(product)"
                [id]="'search-add-to-cart-button-' + product.productId"
                class="flex flex-1 items-center justify-center rounded-md bg-hover-color p-2 text-white hover:bg-opacity-90 sm:flex-none"
                title="Add to Cart"
              >
                <i class="ri-shopping-cart-line"></i>
              </button>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>
