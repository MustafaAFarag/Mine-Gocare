<!-- Backdrop -->
<div
  class="fixed inset-0 z-50 bg-black bg-opacity-50 transition-opacity duration-300"
  [class.opacity-0]="!isOpen"
  [class.invisible]="!isOpen"
  (click)="closeCart()"
  id="cart-sidebar-backdrop"
></div>

<!-- Cart Sidebar -->
<div
  class="fixed bottom-0 right-0 top-0 z-[999] flex w-[80vw] transform flex-col overflow-hidden bg-white shadow-lg transition-transform duration-300 ease-in-out lg:max-w-md"
  [class.translate-x-0]="isOpen"
  [class.translate-x-full]="!isOpen"
  id="cart-sidebar"
>
  <!-- Header -->
  <div class="flex items-center justify-between border-b p-4">
    <h2 class="text-xl font-bold">
      {{ "cart-sidebar.title" | translate }} ({{
        (cartItems$ | async)?.length || 0
      }})
    </h2>
    <button
      class="text-gray-500 hover:text-gray-700 focus:outline-none"
      (click)="closeCart()"
      id="cart-sidebar-close-button"
    >
      <i class="ri-close-line text-xl"></i>
    </button>
  </div>

  <!-- Out of Stock Warning Banner -->
  <div
    *ngIf="hasOutOfStockItems()"
    class="mx-4 mt-2 rounded border-l-4 border-red-400 bg-red-50 p-3"
  >
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <i class="ri-error-warning-line mr-2 text-red-400"></i>
        <span class="text-sm text-red-700">
          {{ "cart-sidebar.outOfStockWarning" | translate }}
        </span>
      </div>
      <button
        (click)="removeOutOfStockItems()"
        class="rounded bg-red-500 px-2 py-1 text-xs text-white transition hover:bg-red-600"
        id="sidebar-remove-out-of-stock-items"
      >
        {{ "cart-sidebar.removeOutOfStockItems" | translate }}
      </button>
    </div>
  </div>

  <!-- Clear Cart -->
  <div class="flex justify-end px-4 py-2" *ngIf="(cartItems$ | async)?.length">
    <button
      class="text-base font-medium text-hover-color hover:text-red-900"
      (click)="clearCart()"
      id="cart-sidebar-clear-cart-button"
    >
      {{ "cart-sidebar.clearCart" | translate }}
    </button>
  </div>

  <!-- Cart Items -->
  <div class="flex-1 overflow-y-auto p-4">
    <ng-container *ngIf="(cartItems$ | async)?.length; else emptyCart">
      <div
        *ngFor="let item of cartItems$ | async"
        class="flex items-center gap-4 border-b py-4"
      >
        <!-- Out of Stock Warning for Item -->
        <div
          *ngIf="isItemOutOfStock(item)"
          class="absolute right-2 top-2 rounded-full bg-red-500 px-2 py-1 text-xs text-white"
        >
          {{ "cart-sidebar.outOfStock" | translate }}
        </div>

        <div class="relative h-20 w-20 flex-shrink-0">
          <img
            [src]="getFullImageUrl(item.image)"
            [alt]="getLocalizedText(item.name)"
            class="h-full w-full object-cover"
            [class.opacity-50]="isItemOutOfStock(item)"
          />
          <!-- Out of Stock Overlay -->
          <div
            *ngIf="isItemOutOfStock(item)"
            class="absolute inset-0 flex items-center justify-center rounded bg-red-500 bg-opacity-20"
          >
            <span
              class="rounded bg-red-500 px-2 py-1 text-xs font-bold text-white"
            >
              {{ "cart-sidebar.outOfStock" | translate }}
            </span>
          </div>
        </div>

        <div class="flex-1">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-medium text-gray-800">
                {{ getLocalizedText(item.name) }}
              </h3>
              <div *ngIf="item.promoCodeDetail">
                <span class="text-xs font-semibold text-blue-600">
                  <i class="ri-gift-line me-1"></i>
                  Promo Code: {{ item.promoCodeDetail.code }}<br />
                </span>
              </div>
              <span class="black text-sm font-bold">
                {{
                  "cart-sidebar.pricePerUnit"
                    | translate
                      : {
                          quantity: item.quantity,
                          price: (item.afterPrice !== undefined
                            ? item.afterPrice
                            : 0
                          ).toFixed(2),
                          currency: item.currency[currentLang],
                        }
                }}
              </span>

              <span
                *ngIf="
                  item.beforePrice !== item.afterPrice &&
                  item.beforePrice !== undefined &&
                  item.afterPrice !== undefined
                "
                class="text-sm text-gray-400 line-through"
              >
                {{
                  (item.beforePrice !== undefined
                    ? item.beforePrice
                    : 0
                  ).toFixed(2)
                }}
                {{ item.currency[currentLang] }}
              </span>
            </div>
            <button
              class="bg-gray-200 px-2 text-lg text-hover-color hover:text-red-900"
              (click)="removeFromCart(item.productId, item.variantId)"
              id="cart-sidebar-remove-from-cart-button"
            >
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>

          <!-- Quantity Controls -->
          <div class="mt-2 flex items-center">
            <div class="ml-auto flex items-center">
              <button
                class="flex h-6 w-6 items-center justify-center rounded-l border text-gray-500 hover:text-gray-700 disabled:cursor-not-allowed disabled:bg-gray-300"
                (click)="
                  updateQuantity(
                    item.productId,
                    item.quantity - 1,
                    item.variantId
                  )
                "
                id="cart-sidebar-decrement-quantity-button"
                [disabled]="isItemOutOfStock(item)"
              >
                <i class="ri-subtract-line"></i>
              </button>
              <span
                class="flex h-6 w-8 items-center justify-center border-b border-t"
                [class.text-red-500]="isItemOutOfStock(item)"
              >
                {{ item.quantity }}
              </span>
              <button
                class="flex h-6 w-6 items-center justify-center rounded-r border text-gray-500 hover:text-gray-700 disabled:cursor-not-allowed disabled:bg-gray-300"
                (click)="
                  updateQuantity(
                    item.productId,
                    item.quantity + 1,
                    item.variantId
                  )
                "
                id="cart-sidebar-increment-quantity-button"
                [disabled]="isItemOutOfStock(item)"
              >
                <i class="ri-add-line"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Empty Cart -->
    <ng-template #emptyCart>
      <div class="flex h-full flex-col items-center justify-center py-12">
        <div class="mb-4 rounded-full bg-gray-100 p-4">
          <i class="ri-shopping-cart-line text-4xl text-gray-400"></i>
        </div>
        <p class="text-lg font-medium text-gray-600">
          {{ "cart-sidebar.empty" | translate }}
        </p>
      </div>
    </ng-template>
  </div>

  <!-- Footer -->
  <div class="border-t p-4" *ngIf="(cartItems$ | async)?.length">
    <div class="mb-4 flex items-center justify-between">
      <span class="font-medium">{{ "cart-sidebar.subtotal" | translate }}</span>
      <span class="font-bold text-hover-color">
        {{ getCurrencySymbol() }}
        {{ (cartTotal$ | async)?.toFixed(2) || "0.00" }}
      </span>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <button
        class="rounded bg-hover-color px-4 py-3 text-center font-medium text-white transition hover:bg-red-900"
        routerLink="/cart"
        (click)="closeCart()"
        id="cart-sidebar-view-cart-button"
      >
        {{ "cart-sidebar.viewCart" | translate }}
      </button>
      <button
        routerLink="/checkout"
        (click)="closeCart()"
        class="rounded bg-hover-color px-4 py-3 text-center font-medium text-white transition hover:bg-red-900 disabled:cursor-not-allowed disabled:bg-gray-400"
        id="cart-sidebar-checkout-button"
        [disabled]="hasOutOfStockItems()"
      >
        {{ "cart-sidebar.checkout" | translate }}
      </button>
    </div>

    <!-- Out of Stock Warning for Checkout -->
    <div *ngIf="hasOutOfStockItems()" class="mt-2 text-center">
      <p class="text-xs text-red-600">
        <i class="ri-error-warning-line mr-1"></i>
        {{ "cart-sidebar.checkoutDisabledWarning" | translate }}
      </p>
    </div>
  </div>
</div>

<!-- Confirmation Dialog -->
<app-confirmation-dialog
  [(visible)]="showRemoveOutOfStockDialog"
  [title]="'cart-sidebar.removeOutOfStockTitle' | translate"
  [message]="'cart-sidebar.removeOutOfStockConfirm' | translate"
  [confirmText]="'cart-sidebar.removeOutOfStockConfirmButton' | translate"
  [cancelText]="'cart-sidebar.cancel' | translate"
  type="warning"
  (confirmed)="confirmRemoveOutOfStockItems()"
></app-confirmation-dialog>
