<!-- Backdrop -->
<div
  class="fixed inset-0 z-50 bg-black bg-opacity-50 transition-opacity duration-300"
  [class.opacity-0]="!isOpen"
  [class.invisible]="!isOpen"
  (click)="closeCart()"
  id="cart-sidebar-backdrop"
></div>

<!-- Cart Sidebar -->
<div
  class="fixed bottom-0 right-0 top-0 z-[999] flex w-[80vw] transform flex-col overflow-hidden bg-white shadow-lg transition-transform duration-300 ease-in-out lg:max-w-md"
  [class.translate-x-0]="isOpen"
  [class.translate-x-full]="!isOpen"
  id="cart-sidebar"
>
  <!-- Header -->
  <div class="flex items-center justify-between border-b p-4">
    <h2 class="text-xl font-bold">
      {{ "cart-sidebar.title" | translate }} ({{
        (cartItems$ | async)?.length || 0
      }})
    </h2>
    <button
      class="text-gray-500 hover:text-gray-700 focus:outline-none"
      (click)="closeCart()"
      id="cart-sidebar-close-button"
    >
      <i class="ri-close-line text-xl"></i>
    </button>
  </div>

  <!-- Clear Cart -->
  <div class="flex justify-end px-4 py-2" *ngIf="(cartItems$ | async)?.length">
    <button
      class="text-base font-medium text-hover-color hover:text-red-900"
      (click)="clearCart()"
      id="cart-sidebar-clear-cart-button"
    >
      {{ "cart-sidebar.clearCart" | translate }}
    </button>
  </div>

  <!-- Cart Items -->
  <div class="flex-1 overflow-y-auto p-4">
    <ng-container *ngIf="(cartItems$ | async)?.length; else emptyCart">
      <div
        *ngFor="let item of cartItems$ | async"
        class="flex items-center gap-4 border-b py-4"
      >
        <div class="h-20 w-20 flex-shrink-0">
          <img
            [src]="getFullImageUrl(item.image)"
            [alt]="getLocalizedText(item.name)"
            class="h-full w-full object-cover"
          />
        </div>

        <div class="flex-1">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-medium text-gray-800">
                {{ getLocalizedText(item.name) }}
              </h3>
              <span class="black text-sm font-bold">
                {{
                  "cart-sidebar.pricePerUnit"
                    | translate
                      : {
                          quantity: item.quantity,
                          price: item.afterPrice.toFixed(2),
                          currency: item.currency[currentLang],
                        }
                }}
              </span>
              <span
                *ngIf="item.beforePrice !== item.afterPrice"
                class="text-sm text-gray-400 line-through"
              >
                {{ item.beforePrice.toFixed(2) }}
                {{ item.currency[currentLang] }}
              </span>
            </div>
            <button
              class="bg-gray-200 px-2 text-lg text-hover-color hover:text-red-900"
              (click)="removeFromCart(item.productId)"
              id="cart-sidebar-remove-from-cart-button"
            >
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>

          <!-- Quantity Controls -->
          <div class="mt-2 flex items-center">
            <div class="ml-auto flex items-center">
              <button
                class="flex h-6 w-6 items-center justify-center rounded-l border text-gray-500 hover:text-gray-700"
                (click)="updateQuantity(item.productId, item.quantity - 1)"
                id="cart-sidebar-decrement-quantity-button"
              >
                <i class="ri-subtract-line"></i>
              </button>
              <span
                class="flex h-6 w-8 items-center justify-center border-b border-t"
              >
                {{ item.quantity }}
              </span>
              <button
                class="flex h-6 w-6 items-center justify-center rounded-r border text-gray-500 hover:text-gray-700"
                (click)="updateQuantity(item.productId, item.quantity + 1)"
                id="cart-sidebar-increment-quantity-button"
              >
                <i class="ri-add-line"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Empty Cart -->
    <ng-template #emptyCart>
      <div class="flex h-full flex-col items-center justify-center py-12">
        <div class="mb-4 rounded-full bg-gray-100 p-4">
          <i class="ri-shopping-cart-line text-4xl text-gray-400"></i>
        </div>
        <p class="text-lg font-medium text-gray-600">
          {{ "cart-sidebar.empty" | translate }}
        </p>
      </div>
    </ng-template>
  </div>

  <!-- Footer -->
  <div class="border-t p-4" *ngIf="(cartItems$ | async)?.length">
    <div class="mb-4 flex items-center justify-between">
      <span class="font-medium">{{ "cart-sidebar.subtotal" | translate }}</span>
      <span class="font-bold text-hover-color">
        {{ getCurrencySymbol() }}
        {{ (cartTotal$ | async)?.toFixed(2) || "0.00" }}
      </span>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <button
        class="rounded bg-hover-color px-4 py-3 text-center font-medium text-white transition hover:bg-red-900"
        routerLink="/cart"
        (click)="closeCart()"
        id="cart-sidebar-view-cart-button"
      >
        {{ "cart-sidebar.viewCart" | translate }}
      </button>
      <button
        routerLink="/checkout"
        (click)="closeCart()"
        class="rounded bg-hover-color px-4 py-3 text-center font-medium text-white transition hover:bg-red-900"
        id="cart-sidebar-checkout-button"
      >
        {{ "cart-sidebar.checkout" | translate }}
      </button>
    </div>
  </div>
</div>
