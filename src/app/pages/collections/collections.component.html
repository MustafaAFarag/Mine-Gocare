<div class="container mx-auto max-w-8xl px-3 py-8">
  <!-- Initial Loading State (entire page) -->
  <div
    *ngIf="isLoading"
    class="flex flex-col items-center justify-center py-12"
  >
    <app-loading></app-loading>
  </div>

  <!-- Content when loaded -->
  <div *ngIf="!isLoading" class=" ">
    <app-breadcrumb
      [soloRoute]="'collections.header' | translate"
    ></app-breadcrumb>

    <!-- Mobile Filter Sidebar -->
    <div
      *ngIf="isMobile && showFilterSidebar"
      class="fixed inset-0 z-50 flex bg-black bg-opacity-50"
    >
      <div class="relative w-4/5 max-w-xs bg-white shadow-xl">
        <app-filter-tab
          [categories]="categories"
          [brands]="brands"
          [activeFilters]="activeFilters"
          [showCategories]="showCategories"
          [showBrands]="showBrands"
          [showPrice]="showPrice"
          [isMobile]="true"
          [categoriesLoading]="categoriesLoading"
          [brandsLoading]="brandsLoading"
          [absoluteMinPrice]="absoluteMinPrice"
          [absoluteMaxPrice]="absoluteMaxPrice"
          [currency]="currency"
          (filterToggled)="handleFilterToggled($event)"
          (categoryToggled)="handleCategoryToggled($event)"
          (brandToggled)="handleBrandToggled($event)"
          (priceRangeChanged)="handlePriceRangeChanged($event)"
          (filterRemoved)="handleFilterRemoved($event)"
          (allFiltersCleared)="handleAllFiltersCleared()"
          (closeFilterSidebar)="closeFilterSidebar()"
        ></app-filter-tab>
      </div>
      <!-- Close area -->
      <div
        id="mobile-filter-overlay"
        class="flex-1"
        (click)="closeFilterSidebar()"
      ></div>
    </div>

    <div class="mt-8 flex flex-col gap-6 lg:flex-row">
      <!-- Desktop Sidebar Filters (only shown on screens 1024px and larger) -->
      <div class="hidden lg:block lg:w-1/4">
        <app-filter-tab
          [categories]="categories"
          [brands]="brands"
          [activeFilters]="activeFilters"
          [showCategories]="showCategories"
          [showBrands]="showBrands"
          [showPrice]="showPrice"
          [categoriesLoading]="categoriesLoading"
          [brandsLoading]="brandsLoading"
          [absoluteMinPrice]="absoluteMinPrice"
          [absoluteMaxPrice]="absoluteMaxPrice"
          [currency]="currency"
          (filterToggled)="handleFilterToggled($event)"
          (categoryToggled)="handleCategoryToggled($event)"
          (brandToggled)="handleBrandToggled($event)"
          (priceRangeChanged)="handlePriceRangeChanged($event)"
          (filterRemoved)="handleFilterRemoved($event)"
          (allFiltersCleared)="handleAllFiltersCleared()"
        ></app-filter-tab>
      </div>

      <!-- Main Content -->
      <div class="w-full lg:w-3/4">
        <!-- Banner -->
        <div class="mb-6 overflow-hidden rounded-lg bg-gray-100">
          <div class="relative">
            <img
              src="/assets/images/settings/gocare/gocare13.jpg"
              alt="{{ 'collections.banner.title' | translate }}"
              class="h-64 w-full object-cover"
            />
            <div
              class="absolute inset-0 flex flex-col justify-center px-8 md:px-16"
            ></div>
          </div>
        </div>

        <!-- Mobile Filter Button -->
        <div *ngIf="isMobile" class="mb-4 flex justify-between">
          <button
            id="mobile-filter-toggle"
            (click)="toggleFilterSidebar()"
            class="flex items-center rounded-md bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300"
          >
            <i class="ri-filter-line mr-2"></i>
            {{ "collections.filters.button" | translate }}
            <span
              *ngIf="activeFilters.length > 0"
              class="ml-2 rounded-full bg-hover-color px-2 py-0.5 text-xs text-white"
            >
              {{ activeFilters.length }}
            </span>
          </button>
        </div>

        <!-- Sorting and View Options -->
        <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
          <div class="flex gap-4">
            <div class="relative">
              <select
                id="sort-order-select"
                (change)="applySortOrder($event)"
                class="appearance-none rounded-md border bg-white py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-red-300 lg:pr-10"
              >
                <option
                  value="price-asc"
                  [selected]="!sortOrder || sortOrder === 'price-asc'"
                >
                  {{ "collections.filters.priceLowToHigh" | translate }}
                </option>
                <option
                  value="price-desc"
                  [selected]="sortOrder === 'price-desc'"
                >
                  {{ "collections.filters.priceHighToLow" | translate }}
                </option>
              </select>
              <i
                class="ri-arrow-down-s-line pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 transform text-gray-400"
              ></i>
            </div>

            <!-- Gender Filter -->
            <div class="relative">
              <select
                id="gender-filter-select"
                (change)="applyGenderFilter($event)"
                class="appearance-none rounded-md border bg-white py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-red-300 lg:pr-10"
              >
                <option
                  value="all"
                  [selected]="!selectedGender || selectedGender.length === 2"
                >
                  {{ "collections.filters.gender.all" | translate }}
                </option>
                <option
                  value="women"
                  [selected]="
                    selectedGender.length === 1 && selectedGender[0] === 0
                  "
                >
                  {{ "collections.filters.gender.women" | translate }}
                </option>
                <option
                  value="men"
                  [selected]="
                    selectedGender.length === 1 && selectedGender[0] === 1
                  "
                >
                  {{ "collections.filters.gender.men" | translate }}
                </option>
              </select>
              <i
                class="ri-arrow-down-s-line pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 transform text-gray-400"
              ></i>
            </div>
          </div>

          <!-- View Mode Buttons (Hidden on Mobile) -->
          <div class="hidden gap-2 sm:flex">
            <button
              id="view-mode-grid2"
              (click)="setViewMode('grid2')"
              [ngClass]="{
                'bg-hover-color text-white': viewMode === 'grid2',
                'bg-gray-200 text-gray-600': viewMode !== 'grid2',
              }"
              class="rounded p-2"
              title="{{ 'collections.filters.viewMode.grid2' | translate }}"
            >
              <i class="ri-layout-2-line"></i>
            </button>
            <button
              id="view-mode-grid3"
              (click)="setViewMode('grid3')"
              [ngClass]="{
                'bg-hover-color text-white': viewMode === 'grid3',
                'bg-gray-200 text-gray-600': viewMode !== 'grid3',
              }"
              class="rounded p-2"
              title="{{ 'collections.filters.viewMode.grid3' | translate }}"
            >
              <i class="ri-layout-3-line"></i>
            </button>
            <button
              id="view-mode-grid4"
              (click)="setViewMode('grid4')"
              [ngClass]="{
                'bg-hover-color text-white': viewMode === 'grid4',
                'bg-gray-200 text-gray-600': viewMode !== 'grid4',
              }"
              class="rounded p-2"
              title="{{ 'collections.filters.viewMode.grid4' | translate }}"
            >
              <i class="ri-layout-4-line"></i>
            </button>
            <button
              id="view-mode-list"
              (click)="setViewMode('list')"
              [ngClass]="{
                'bg-hover-color text-white': viewMode === 'list',
                'bg-gray-200 text-gray-600': viewMode !== 'list',
              }"
              class="rounded p-2"
              title="{{ 'collections.filters.viewMode.list' | translate }}"
            >
              <i class="ri-list-check"></i>
            </button>
          </div>
        </div>

        <!-- Products Loading Indicator -->
        <div
          *ngIf="productsLoading"
          class="flex flex-col items-center justify-center py-12"
        >
          <app-loading></app-loading>
        </div>

        <!-- No Products Found Message -->
        <div
          *ngIf="!productsLoading && filteredProducts.length === 0"
          class="flex flex-col items-center justify-center py-12 text-center"
        >
          <i class="ri-shopping-bag-line mb-4 text-5xl text-gray-400"></i>
          <h3 class="mb-2 text-xl font-medium text-gray-700">
            {{ "collections.noProductsFound.title" | translate }}
          </h3>
          <p class="text-gray-500">
            {{ "collections.noProductsFound.message" | translate }}
          </p>
          <button
            id="clear-filters-no-products"
            (click)="clearAllFilters()"
            class="mt-4 rounded-md bg-hover-color px-4 py-2 text-white hover:bg-opacity-90"
          >
            {{ "collections.filters.clearAll" | translate }}
          </button>
        </div>

        <!-- Grid View - only show when not loading products -->
        <div *ngIf="!productsLoading && filteredProducts.length > 0">
          <div
            *ngIf="viewMode === 'grid2'"
            class="grid auto-rows-fr grid-cols-1 gap-6 md:grid-cols-2"
          >
            <app-product-card
              *ngFor="let product of paginatedProducts"
              [product]="product"
            ></app-product-card>
          </div>

          <div
            *ngIf="viewMode === 'grid3'"
            class="grid auto-rows-fr grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3"
          >
            <app-product-card
              *ngFor="let product of paginatedProducts"
              [product]="product"
            ></app-product-card>
          </div>

          <div
            *ngIf="viewMode === 'grid4'"
            class="grid auto-rows-fr grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"
          >
            <app-product-card
              *ngFor="let product of paginatedProducts"
              [product]="product"
            ></app-product-card>
          </div>

          <!-- List View -->
          <div *ngIf="viewMode === 'list'" class="flex flex-col gap-6">
            <div
              *ngFor="let product of paginatedProducts"
              class="product-card flex flex-col overflow-hidden rounded-lg bg-white shadow-sm transition-shadow hover:shadow-md sm:flex-row"
            >
              <!-- Product Image -->
              <div class="relative w-full sm:w-2/5">
                <div class="relative pt-[100%]">
                  <!-- Rating Badge -->
                  <div
                    class="absolute bottom-2 left-2 z-10 bg-gray-100 px-2 py-1 shadow"
                  >
                    <span class="flex items-center font-medium">
                      <i class="ri-star-fill mr-1 text-sm text-yellow-400"></i>
                      {{ product.rating.toFixed(1) }}
                    </span>
                  </div>

                  <img
                    [src]="getFullImageUrl(product.mainImageUrl)"
                    [alt]="product.name.en"
                    class="absolute inset-0 h-full w-full cursor-pointer object-cover"
                    (click)="
                      navigateToProductDetails(
                        product.productId,
                        product.variantId
                      )
                    "
                  />
                  <div class="icon-wrapper absolute right-2 top-2 z-10">
                    <i
                      id="wishlist-{{ product.productId }}"
                      [class]="
                        isInWishlist(product)
                          ? 'ri-heart-fill text-red-500'
                          : 'ri-heart-line'
                      "
                      class="relative z-20 cursor-pointer rounded-full bg-white p-1 text-xl text-hover-color shadow"
                      (click)="toggleWishlist(product, $event)"
                    ></i>

                    <i
                      id="cart-{{ product.productId }}"
                      class="ri-shopping-cart-line extra-icon-1 absolute left-0 cursor-pointer rounded-full bg-white p-1 text-xl text-hover-color shadow"
                      (click)="addToCart(product)"
                    ></i>
                    <i
                      id="quick-view-{{ product.productId }}"
                      class="ri-search-line extra-icon-2 absolute left-0 cursor-pointer rounded-full bg-white p-1 text-xl text-hover-color shadow"
                      (click)="openQuickView(product, $event)"
                    ></i>
                  </div>
                </div>
              </div>

              <!-- Product Details -->
              <div class="flex w-full flex-col justify-center p-4 sm:w-4/5">
                <!-- Brand -->
                <p class="mb-1 text-sm text-gray-500">
                  {{
                    languageService.getCurrentLanguage() === "ar"
                      ? product.brand.ar
                      : product.brand.en
                  }}
                </p>

                <!-- Product Name -->
                <h3
                  id="product-name-{{ product.productId }}"
                  class="mb-2 cursor-pointer text-lg font-medium text-gray-800"
                  (click)="
                    navigateToProductDetails(
                      product.productId,
                      product.variantId
                    )
                  "
                >
                  {{
                    languageService.getCurrentLanguage() === "ar"
                      ? product.name.ar
                      : product.name.en
                  }}
                </h3>

                <!-- Price -->
                <div class="flex items-center gap-2">
                  <span class="font-semibold">
                    {{ product.priceAfterDiscount }}
                    {{
                      languageService.getCurrentLanguage() === "ar"
                        ? product.currency.name.ar
                        : product.currency.name.en
                    }}
                  </span>
                  <span
                    *ngIf="product.discountPercentage > 0"
                    class="text-sm text-gray-500 line-through"
                  >
                    {{ product.priceBeforeDiscount }}
                    {{
                      languageService.getCurrentLanguage() === "ar"
                        ? product.currency.name.ar
                        : product.currency.name.en
                    }}
                  </span>
                  <span
                    *ngIf="product.discountPercentage > 0"
                    class="text-hover-color"
                  >
                    {{
                      "collections.productCard.discount"
                        | translate
                          : {
                              discountPercentage:
                                product.discountPercentage.toFixed(0),
                            }
                    }}
                  </span>
                </div>

                <!-- Stock Status -->
                <div
                  *ngIf="product.lowQuantity"
                  class="mt-2 text-xs text-hover-color"
                >
                  {{
                    "collections.productCard.onlyLeftInStock"
                      | translate: { stockCount: product.stockCount }
                  }}
                </div>
              </div>
            </div>
          </div>

          <!-- Pagination Controls -->
          <div class="mt-8 flex justify-center">
            <div class="flex items-center gap-2">
              <!-- Previous Page Button -->
              <button
                id="prev-page"
                [disabled]="currentPage === 1"
                (click)="changePage(currentPage - 1)"
                [ngClass]="{
                  'cursor-not-allowed text-gray-400': currentPage === 1,
                  'hover:bg-hover-color hover:text-white': currentPage !== 1,
                }"
                class="flex h-10 w-10 items-center justify-center rounded-md border border-gray-300"
              >
                <i
                  [class]="
                    languageService.getCurrentLanguage() === 'ar'
                      ? 'ri-arrow-right-s-line'
                      : 'ri-arrow-left-s-line'
                  "
                ></i>
              </button>

              <!-- Page Number Buttons with Ellipsis -->
              <ng-container *ngFor="let page of getPageArray()">
                <!-- Show ellipsis -->
                <span
                  *ngIf="page.ellipsis"
                  class="flex h-10 items-center justify-center px-2"
                >
                  ...
                </span>

                <!-- Show page number -->
                <button
                  *ngIf="!page.ellipsis"
                  id="page-{{ page.number }}"
                  (click)="changePage(page.number)"
                  [ngClass]="{
                    'bg-hover-color/80 text-white': currentPage === page.number,
                    'hover:bg-gray-100': currentPage !== page.number,
                  }"
                  class="flex h-10 w-10 items-center justify-center rounded-md border border-gray-300"
                >
                  {{ page.display }}
                </button>
              </ng-container>

              <!-- Next Page Button -->
              <button
                id="next-page"
                [disabled]="currentPage === totalPages"
                (click)="changePage(currentPage + 1)"
                [ngClass]="{
                  'cursor-not-allowed text-gray-400':
                    currentPage === totalPages,
                  'hover:bg-hover-color hover:text-white':
                    currentPage !== totalPages,
                }"
                class="flex h-10 w-10 items-center justify-center rounded-md border border-gray-300"
              >
                <i
                  [class]="
                    languageService.getCurrentLanguage() === 'ar'
                      ? 'ri-arrow-left-s-line'
                      : 'ri-arrow-right-s-line'
                  "
                ></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<p-toast position="top-left" styleClass="black-text-toast"></p-toast>

<style>
  /* Default styles for mobile and tablet */
  .extra-icon-1,
  .extra-icon-2 {
    opacity: 1;
    transform: translateY(30px);
  }

  .extra-icon-2 {
    transform: translateY(60px);
  }

  .add-to-cart-btn {
    opacity: 1;
    transform: translateY(0);
  }

  .limited-time-wrapper {
    animation: slide-left 5s linear infinite;
  }

  /* Hover effects for lg screens and up */
  @media (min-width: 1024px) {
    .extra-icon-1,
    .extra-icon-2 {
      opacity: 0;
      transform: translateY(0);
    }

    .add-to-cart-btn {
      opacity: 0;
      transform: translateY(100%);
    }

    .product-card:hover .extra-icon-1 {
      opacity: 1;
      transform: translateY(40px);
    }

    .product-card:hover .extra-icon-2 {
      opacity: 1;
      transform: translateY(80px);
    }

    .product-card:hover .add-to-cart-btn {
      opacity: 1;
      transform: translateY(0);
    }

    .limited-time-wrapper {
      animation: none;
    }

    .product-card:hover .limited-time-wrapper {
      animation: slide-left 5s linear infinite;
    }
  }

  .extra-icon-1,
  .extra-icon-2,
  .add-to-cart-btn {
    transition: all 0.5s ease;
  }

  @keyframes slide-left {
    0% {
      transform: translateX(0%);
    }
    100% {
      transform: translateX(-50%);
    }
  }
</style>
