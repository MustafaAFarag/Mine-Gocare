<div class="rounded-lg bg-white p-4 shadow-sm lg:p-6">
  <!-- Address Book Header -->
  <div class="flex items-center justify-between gap-4 p-4 lg:gap-6 lg:p-6">
    <h2 class="text-lg font-bold text-gray-800 lg:text-xl">
      {{ "address.title" | translate }}
    </h2>
    <button
      *ngIf="!showAddressForm"
      (click)="addNewAddress()"
      class="flex items-center gap-1.5 rounded bg-hover-color px-3 py-1.5 text-sm text-white transition hover:bg-red-700 lg:gap-2 lg:px-4 lg:py-2 lg:text-base"
      id="address-add-new-address-button"
    >
      <i class="ri-add-line"></i> {{ "address.addNew" | translate }}
    </button>
  </div>

  <!-- Address Form -->
  <div *ngIf="showAddressForm" class="rounded-lg border p-4 lg:p-6">
    <div class="flex items-center justify-between gap-3 lg:gap-4">
      <h3 class="text-base font-semibold lg:text-lg">
        {{
          editingAddressId
            ? ("address.updateAddress" | translate)
            : ("address.addNew" | translate)
        }}
      </h3>
      <button
        (click)="cancelForm()"
        id="address-cancel-form-header-button"
        class="text-gray-500 hover:text-gray-700"
      >
        <i class="ri-close-line text-lg lg:text-xl"></i>
      </button>
    </div>

    <form [formGroup]="addressForm" (ngSubmit)="submitForm()" id="address-form">
      <div class="grid grid-cols-1 gap-3 md:grid-cols-2 lg:gap-4">
        <!-- Full Name -->
        <div class="form-group">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.fullName" | translate }}</label
          >
          <input
            type="text"
            formControlName="fullName"
            id="address-full-name-input"
            class="w-full rounded-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
            [ngClass]="{
              'border-red-500':
                addressForm.get('fullName')?.invalid &&
                addressForm.get('fullName')?.touched,
            }"
          />
          <div
            *ngIf="
              addressForm.get('fullName')?.invalid &&
              addressForm.get('fullName')?.touched
            "
            class="mt-0.5 text-xs text-red-500 lg:mt-1 lg:text-sm"
          >
            {{ "address.validation.fullNameRequired" | translate }}
          </div>
        </div>

        <!-- Phone Number -->
        <div class="form-group">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.phoneNumber" | translate }}</label
          >
          <div class="flex w-full">
            <!-- Country dropdown with flag -->
            <div class="relative">
              <button
                type="button"
                (click)="showCountryDropdown = !showCountryDropdown"
                id="address-phone-country-dropdown-button"
                class="flex h-full items-center gap-1 rounded-l-md border border-gray-300 bg-white px-2 py-1.5 text-sm hover:bg-gray-50 lg:px-3 lg:py-2 lg:text-base"
              >
                <img
                  [src]="selectedPhoneCountry.flag"
                  [alt]="selectedPhoneCountry.name | translate"
                  class="h-4 w-6 object-contain"
                />
                <span class="px-2 text-sm font-medium">{{
                  selectedPhoneCountry.phoneCode
                }}</span>
              </button>
              <!-- Dropdown menu -->
              <div
                *ngIf="showCountryDropdown"
                class="absolute top-full z-50 mt-1 w-48 rounded-md border border-gray-300 bg-white shadow-lg"
                [class.right-0]="currentLang === 'ar'"
                [class.left-0]="currentLang !== 'ar'"
              >
                <div
                  *ngFor="let country of phoneCountries"
                  [id]="'address-phone-country-dropdown-item-' + country.code"
                  (click)="
                    selectedPhoneCountry = country; showCountryDropdown = false
                  "
                  class="flex cursor-pointer items-center gap-2 px-2 py-2 hover:bg-gray-50"
                >
                  <img
                    [src]="country.flag"
                    [alt]="country.name | translate"
                    class="h-4 w-6 object-contain"
                  />
                  <span class="text-sm"
                    >{{ country.name | translate }} ({{
                      country.phoneCode
                    }})</span
                  >
                </div>
              </div>
            </div>
            <input
              type="text"
              formControlName="phoneNumber"
              id="address-phone-number-input"
              class="w-full rounded-r-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
              [ngClass]="{
                'border-red-500':
                  addressForm.get('phoneNumber')?.invalid &&
                  addressForm.get('phoneNumber')?.touched,
              }"
              inputmode="numeric"
              pattern="[0-9]*"
              (paste)="$event.preventDefault()"
              (keypress)="
                ($event.charCode >= 48 && $event.charCode <= 57) ||
                  $event.preventDefault()
              "
            />
          </div>
          <div
            *ngIf="
              addressForm.get('phoneNumber')?.invalid &&
              addressForm.get('phoneNumber')?.touched
            "
            class="mt-0.5 text-xs text-red-500 lg:mt-1 lg:text-sm"
          >
            <ng-container
              *ngIf="addressForm.get('phoneNumber')?.errors?.['required']"
            >
              {{ "address.validation.phoneNumberRequired" | translate }}
            </ng-container>
            <ng-container
              *ngIf="
                addressForm.get('phoneNumber')?.errors?.['invalidPhoneNumber']
              "
            >
              {{ "address.validation.phoneNumberInvalid" | translate }}
            </ng-container>
          </div>
        </div>

        <!-- Country -->
        <div class="form-group">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.country" | translate }}</label
          >
          <select
            formControlName="countryId"
            id="address-country-input"
            class="w-full rounded-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
            [ngClass]="{
              'border-red-500':
                addressForm.get('countryId')?.invalid &&
                addressForm.get('countryId')?.touched,
            }"
          >
            <option [ngValue]="null" disabled>
              {{ "address.selectCountry" | translate }}
            </option>
            @for (country of countries; track $index) {
              <option value="{{ country.id }}">
                {{ country.name[currentLang] }}
              </option>
            }
          </select>
          <div
            *ngIf="
              addressForm.get('countryId')?.invalid &&
              addressForm.get('countryId')?.touched
            "
            class="mt-0.5 text-xs text-red-500 lg:mt-1 lg:text-sm"
          >
            {{ "address.validation.countryRequired" | translate }}
          </div>
        </div>

        <!-- City -->
        <div class="form-group">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.city" | translate }}</label
          >
          <div class="relative">
            <select
              formControlName="cityId"
              id="address-city-input"
              class="w-full rounded-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
              [ngClass]="{
                'border-red-500':
                  addressForm.get('cityId')?.invalid &&
                  addressForm.get('cityId')?.touched,
                'opacity-50': loadingCities,
              }"
              [disabled]="loadingCities"
            >
              <option [ngValue]="null" disabled>
                {{
                  loadingCities
                    ? ("common.loading" | translate)
                    : ("address.selectCity" | translate)
                }}
              </option>
              @for (city of cities; track $index) {
                <option value="{{ city.id }}">
                  {{ city.name[currentLang] }}
                </option>
              }
            </select>
            @if (loadingCities) {
              <div class="absolute right-2 top-1/2 -translate-y-1/2">
                <svg
                  class="h-4 w-4 animate-spin text-gray-500"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </div>
            }
          </div>
          <div
            *ngIf="
              addressForm.get('cityId')?.invalid &&
              addressForm.get('cityId')?.touched
            "
            class="mt-0.5 text-xs text-red-500 lg:mt-1 lg:text-sm"
          >
            {{ "address.validation.cityRequired" | translate }}
          </div>
        </div>

        <!-- District -->
        <div class="form-group">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.district" | translate }}</label
          >
          <div class="relative">
            <select
              formControlName="districtId"
              id="address-district-input"
              class="w-full rounded-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
              [ngClass]="{
                'border-red-500':
                  addressForm.get('districtId')?.invalid &&
                  addressForm.get('districtId')?.touched,
                'opacity-50': loadingDistricts,
              }"
              [disabled]="loadingDistricts"
            >
              <option [ngValue]="null" disabled>
                {{
                  loadingDistricts
                    ? ("common.loading" | translate)
                    : ("address.selectDistrict" | translate)
                }}
              </option>
              @for (district of districts; track $index) {
                <option value="{{ district.id }}">
                  {{ district.name[currentLang] }}
                </option>
              }
            </select>
            @if (loadingDistricts) {
              <div class="absolute right-2 top-1/2 -translate-y-1/2">
                <svg
                  class="h-4 w-4 animate-spin text-gray-500"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </div>
            }
          </div>
          <div
            *ngIf="
              addressForm.get('districtId')?.invalid &&
              addressForm.get('districtId')?.touched
            "
            class="mt-0.5 text-xs text-red-500 lg:mt-1 lg:text-sm"
          >
            {{ "address.validation.districtRequired" | translate }}
          </div>
        </div>

        <!-- Type -->
        <div class="form-group">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.type" | translate }}</label
          >
          <select
            formControlName="type"
            id="address-type-input"
            class="w-full rounded-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
          >
            <option [value]="0">{{ "address.types.home" | translate }}</option>
            <option [value]="1">{{ "address.types.work" | translate }}</option>
            <option [value]="2">
              {{ "address.types.office" | translate }}
            </option>
            <option [value]="3">{{ "address.types.other" | translate }}</option>
          </select>
        </div>

        <!-- Address -->
        <div class="form-group md:col-span-2">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.addressLine" | translate }}</label
          >
          <textarea
            formControlName="address"
            rows="2"
            id="address-address-textarea"
            class="w-full rounded-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
            [ngClass]="{
              'border-red-500':
                addressForm.get('address')?.invalid &&
                addressForm.get('address')?.touched,
            }"
          ></textarea>
          <div
            *ngIf="
              addressForm.get('address')?.invalid &&
              addressForm.get('address')?.touched
            "
            class="mt-0.5 text-xs text-red-500 lg:mt-1 lg:text-sm"
          >
            {{ "address.validation.addressRequired" | translate }}
          </div>
        </div>

        <!-- Map Address -->
        <div class="form-group md:col-span-2">
          <label
            class="mb-0.5 block text-xs font-medium text-gray-700 lg:mb-1 lg:text-sm"
            >{{ "address.mapAddress" | translate }}</label
          >
          <input
            type="text"
            formControlName="mapAddress"
            id="address-map-address-input"
            class="w-full rounded-md border border-gray-300 bg-white px-2.5 py-1.5 text-sm focus:border-hover-color focus:outline-none lg:px-3 lg:py-2 lg:text-base"
          />
        </div>

        <!-- Default Address Checkbox -->
        <div
          class="form-group md:col-span-2"
          *ngIf="editingAddressId || addresses.length === 0"
        >
          <div class="flex items-center gap-1.5 lg:gap-2">
            <input
              type="checkbox"
              id="address-is-default-checkbox"
              formControlName="isDefault"
              class="h-3.5 w-3.5 text-hover-color focus:ring-hover-color lg:h-4 lg:w-4"
            />
            <label
              for="address-is-default-checkbox"
              class="text-xs text-gray-700 lg:text-sm"
            >
              {{ "address.setAsDefault" | translate }}
            </label>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="mt-4 flex justify-end gap-2 lg:mt-6 lg:gap-3">
        <button
          type="button"
          (click)="cancelForm()"
          id="address-cancel-form-button"
          class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 lg:px-4 lg:py-2 lg:text-sm"
        >
          {{ "common.cancel" | translate }}
        </button>
        <button
          type="submit"
          [disabled]="submitting"
          id="address-submit-form-button"
          class="rounded-md bg-hover-color px-3 py-1.5 text-xs font-medium text-white hover:bg-red-700 disabled:opacity-70 lg:px-4 lg:py-2 lg:text-sm"
        >
          <span *ngIf="submitting">{{ "common.saving" | translate }}</span>
          <span *ngIf="!submitting">{{
            editingAddressId
              ? ("common.update" | translate)
              : ("common.save" | translate)
          }}</span>
        </button>
      </div>
    </form>
  </div>

  <!-- Loading State -->
  <div
    *ngIf="loading"
    class="py-6 text-center text-sm text-gray-500 lg:py-8 lg:text-base"
  >
    <p>{{ "common.loading" | translate }}</p>
  </div>

  <!-- Address Cards -->
  <div
    *ngIf="!loading && !showAddressForm"
    class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 lg:gap-6"
  >
    <div
      *ngFor="let address of addresses"
      class="flex h-full flex-col overflow-hidden rounded-lg border"
    >
      <!-- Address Type Label -->
      <div class="flex items-center justify-between border-b p-3 lg:p-4">
        <h3 class="text-sm font-medium text-gray-800 lg:text-base">
          {{ address.fullName }}
        </h3>
        <span
          class="rounded-md px-2 py-0.5 text-xs font-medium lg:px-3 lg:py-1 lg:text-sm"
          [ngClass]="getTypeClass(address.type)"
        >
          {{ getTypeLabel(address.type) }}
        </span>
      </div>

      <!-- Address Details -->
      <div class="flex-grow p-3 lg:p-4">
        <div class="flex flex-col gap-1.5 lg:gap-2">
          <p class="text-sm text-gray-700 lg:text-base">
            {{ address.address }}<br />
            {{ getLocalizedName(address.city) }},
            {{ getLocalizedName(address.district) }}<br />
            {{ getLocalizedName(address.country) }}
          </p>
          <p
            class="flex items-center gap-1.5 text-sm text-gray-700 lg:gap-2 lg:text-base"
          >
            <span class="text-gray-500"
              >{{ "address.phoneNumber" | translate }}:</span
            >
            {{ address.phoneNumber }}
          </p>
          <p
            *ngIf="address.isDefault"
            class="flex items-center gap-1 text-xs text-green-600 lg:text-sm"
          >
            <i class="ri-check-line"></i>
            {{ "address.defaultAddress" | translate }}
          </p>
        </div>
      </div>

      <!-- Address Actions -->
      <div class="mt-auto flex border-t">
        <button
          (click)="editAddress(address.id)"
          id="address-edit-address-button"
          class="flex-1 border-r py-2 text-xs text-gray-700 transition hover:bg-gray-50 lg:py-3 lg:text-sm"
          [disabled]="deletingAddressId === address.id"
        >
          {{ "common.edit" | translate }}
        </button>
        <button
          (click)="removeAddress(address.id)"
          id="address-remove-address-button"
          class="flex-1 py-2 text-xs text-gray-700 transition hover:bg-gray-50 lg:py-3 lg:text-sm"
          [disabled]="deletingAddressId === address.id"
        >
          <span *ngIf="deletingAddressId !== address.id">{{
            "common.remove" | translate
          }}</span>
          <span
            *ngIf="deletingAddressId === address.id"
            class="flex items-center justify-center gap-1.5 lg:gap-2"
          >
            <svg
              class="h-3.5 w-3.5 animate-spin lg:h-4 lg:w-4"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            {{ "common.removing" | translate }}
          </span>
        </button>
      </div>
    </div>

    <!-- Empty State (shown when no addresses) -->
    <div
      *ngIf="!loading && addresses.length === 0 && !showAddressForm"
      class="col-span-full py-6 text-center text-sm text-gray-500 lg:py-8 lg:text-base"
    >
      <div class="flex flex-col items-center gap-3 lg:gap-4">
        <i class="ri-map-pin-line text-3xl text-gray-400 lg:text-4xl"></i>
        <p>{{ "address.noAddresses" | translate }}</p>
        <button
          (click)="addNewAddress()"
          id="address-add-first-address-button"
          class="rounded bg-hover-color px-3 py-1.5 text-sm text-white transition hover:bg-red-700 lg:px-4 lg:py-2 lg:text-base"
        >
          {{ "address.addFirstAddress" | translate }}
        </button>
      </div>
    </div>
  </div>
</div>
<p-toast position="top-left" styleClass="black-text-toast"></p-toast>
