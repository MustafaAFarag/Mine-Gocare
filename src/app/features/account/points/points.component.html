<p-toast position="top-left" styleClass="black-text-toast"></p-toast>

<div *ngIf="isLoadingPoints || isLoadingSettings || isLoadingTotalPoints">
  <app-loading></app-loading>
</div>

<div
  class="rounded-lg bg-white shadow-sm"
  *ngIf="!(isLoadingPoints || isLoadingSettings || isLoadingTotalPoints)"
>
  <div class="flex flex-col gap-4 p-4 sm:p-6">
    <!-- Points Balance and Exchange Rate -->
    <div
      class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
    >
      <div class="flex items-center gap-4">
        <div class="rounded-md bg-red-100 p-2 sm:p-3">
          <i class="ri-coin-line text-xl text-hover-color sm:text-2xl"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-500 sm:text-base">
            {{ "points.totalPoints" | translate }}
          </h3>
          <p class="text-lg font-bold text-gray-800 sm:text-xl">
            {{ clientPoints }} {{ "points.points" | translate }}
          </p>
          <p class="text-sm text-gray-600">
            {{ "common.currency" | translate }}
            {{ getConvertedAmount() | number: "1.2-2" }}
          </p>
        </div>
        <div class="flex items-center gap-4">
          <button
            (click)="openRedeemModal()"
            id="points-redeem-button"
            [disabled]="clientPoints === 0"
            class="rounded-md bg-hover-color px-4 py-2 text-sm font-medium text-white hover:bg-hover-color/90 disabled:cursor-not-allowed disabled:opacity-50 sm:text-base"
          >
            {{ "points.redeemButton" | translate }}
          </button>
        </div>
      </div>
      <div
        class="flex items-center gap-2 rounded-md bg-gray-50 px-3 py-2 sm:px-4"
      >
        <i class="ri-information-line text-gray-500"></i>
        <span class="text-sm text-gray-700 sm:text-base"
          >1 {{ "points.points" | translate }} =
          {{ "common.currency" | translate }}
          {{ pointsClientPreview.exchangeRate.toFixed(2) || "0.00" }}
          {{ "points.balance" | translate }}</span
        >
      </div>
    </div>

    <!-- Points Expiration Hint -->
    <div
      *ngIf="hasExpiringPoints()"
      class="flex items-center gap-2 rounded-md bg-yellow-50 px-3 py-2 sm:px-4"
    >
      <i class="ri-time-line text-yellow-500"></i>
      <span class="text-sm text-yellow-700 sm:text-base">
        {{
          "points.expirationHint"
            | translate
              : {
                  date: getFormattedExpiryDate(),
                  points: pointsClientPreview.nearestExpiredPoints,
                }
        }}
      </span>
    </div>
  </div>

  <!-- Points History View -->
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="border-b border-t">
          <th
            class="px-3 py-3 text-left text-sm font-medium text-gray-700 sm:px-4 sm:py-4 sm:text-base"
          >
            {{ "common.date" | translate }}
          </th>
          <th
            class="px-3 py-3 text-left text-sm font-medium text-gray-700 sm:px-4 sm:py-4 sm:text-base"
          >
            {{ "common.description" | translate }}
          </th>
          <th
            class="px-3 py-3 text-left text-sm font-medium text-gray-700 sm:px-4 sm:py-4 sm:text-base"
          >
            {{ "points.points" | translate }}
          </th>
          <th
            class="px-3 py-3 text-left text-sm font-medium text-gray-700 sm:px-4 sm:py-4 sm:text-base"
          >
            {{ "common.status" | translate }}
          </th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let history of pointsClientPreview?.pointHistoryDetails"
          class="border-b hover:bg-gray-50"
        >
          <td
            class="px-3 py-3 text-sm text-gray-700 sm:px-4 sm:py-4 sm:text-base"
          >
            {{ history.creationDate | date: "medium" }}
          </td>
          <td
            class="px-3 py-3 text-sm text-gray-700 sm:px-4 sm:py-4 sm:text-base"
          >
            {{ history.title[currentLang] }}
          </td>
          <td
            class="px-3 py-3 text-sm text-gray-700 sm:px-4 sm:py-4 sm:text-base"
          >
            {{ history.points }}
          </td>
          <td class="px-3 py-3 sm:px-4 sm:py-4">
            <span
              class="rounded-md px-2 py-1 text-xs font-medium sm:px-3 sm:text-sm"
              [ngClass]="{
                'bg-yellow-100 text-yellow-600': history.isHolded,
                'bg-green-100 text-green-600': !history.isHolded,
              }"
            >
              {{
                history.isHolded
                  ? ("points.pending" | translate)
                  : ("points.earned" | translate)
              }}
            </span>
          </td>
        </tr>
        <tr *ngIf="!pointsClientPreview?.pointHistoryDetails?.length">
          <td colspan="4" class="py-6 text-center text-gray-500 sm:py-8">
            <div class="flex flex-col items-center gap-2">
              <i class="ri-coin-line text-3xl text-gray-400 sm:text-4xl"></i>
              <p class="text-sm sm:text-base">
                {{ "points.noTransactions" | translate }}
              </p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="flex items-center justify-center gap-1 border-t p-3 sm:p-4">
      <button
        (click)="previousPage()"
        id="points-previous-page-button"
        class="rounded-md p-1.5 text-gray-600 hover:bg-gray-100 sm:p-2"
        [disabled]="currentPage === 1"
        [class.opacity-50]="currentPage === 1"
      >
        <i class="ri-arrow-left-s-line text-lg sm:text-xl"></i>
      </button>

      <button
        *ngFor="let page of getPageNumbers()"
        (click)="goToPage(page)"
        id="points-page-button"
        class="flex h-8 min-w-[32px] items-center justify-center rounded-md text-sm sm:h-9 sm:min-w-[36px] sm:text-base"
        [class.bg-hover-color]="currentPage === page"
        [class.text-white]="currentPage === page"
        [class.hover:bg-gray-100]="currentPage !== page"
        [class.text-gray-700]="currentPage !== page"
      >
        {{ page }}
      </button>

      <button
        (click)="nextPage()"
        id="points-next-page-button"
        class="rounded-md p-1.5 text-gray-600 hover:bg-gray-100 sm:p-2"
        [disabled]="currentPage === totalPages"
        [class.opacity-50]="currentPage === totalPages"
      >
        <i class="ri-arrow-right-s-line text-lg sm:text-xl"></i>
      </button>
    </div>
  </div>

  <!-- Points Redeem Modal -->
  <app-points-redeem-modal
    [visible]="showRedeemModal"
    [availablePoints]="clientPoints"
    [exchangeRate]="pointsClientPreview.exchangeRate || 0.01"
    [isRedeeming]="isRedeeming"
    (close)="closeRedeemModal()"
    (redeem)="redeemPoints($event)"
  ></app-points-redeem-modal>
</div>
