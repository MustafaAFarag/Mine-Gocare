<!-- Sidebar Filters -->
<div class="w-full rounded-lg bg-gray-100 p-4 shadow-sm">
  <!-- Mobile Close Button -->
  <div *ngIf="isMobile" class="mb-4 flex justify-end">
    <button (click)="closeSidebar()" class="text-gray-500 hover:text-gray-700">
      <i class="ri-close-line text-xl"></i>
    </button>
  </div>

  <!-- Active Filters -->
  <div class="mb-6">
    <div class="mb-4 flex items-center justify-between">
      <h3 class="font-medium text-gray-800">
        {{ "collections.filters.button" | translate }}
      </h3>
      <button
        *ngIf="activeFilters.length > 0"
        (click)="clearAllFilters()"
        class="text-sm text-hover-color hover:text-hover-color"
      >
        {{ "collections.filters.clearAll" | translate }}
      </button>
    </div>

    <div class="flex flex-wrap gap-2">
      <div
        *ngFor="let filter of activeFilters"
        class="flex items-center bg-gray-200 px-3 py-1 text-sm"
      >
        <span>{{ filter }}</span>
        <button
          (click)="removeFilter(filter)"
          class="ml-2 text-gray-500 hover:text-gray-700"
        >
          <i class="ri-close-line"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Categories -->
  <div class="border-t pb-2 pt-4">
    <div
      class="mb-4 flex cursor-pointer items-center justify-between"
      (click)="toggleFilter('categories')"
    >
      <h3 class="font-medium text-gray-800">
        {{ "collections.filterSidebar.categories" | translate }}
      </h3>
      <i
        [class]="showCategories ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"
      ></i>
    </div>

    <div *ngIf="showCategories">
      <div class="relative mb-4">
        <input
          type="text"
          placeholder="{{ 'Search' | translate }}"
          [(ngModel)]="categorySearchTerm"
          class="w-full rounded-md border bg-white px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-hover-color"
        />
        <div class="absolute right-3 top-1/2 -translate-y-1/2 transform">
          <i
            *ngIf="!categorySearchTerm"
            class="ri-search-line text-gray-400"
          ></i>
          <i
            *ngIf="categorySearchTerm"
            class="ri-close-line cursor-pointer text-gray-600 hover:text-gray-800"
            (click)="categorySearchTerm = ''"
          ></i>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div *ngIf="categoriesLoading" class="flex justify-center py-4">
        <div
          class="h-6 w-6 animate-spin rounded-full border-2 border-t-2 border-hover-color"
        ></div>
      </div>

      <!-- Empty Categories -->
      <div
        *ngIf="!categoriesLoading && filteredCategories.length === 0"
        class="py-4 text-center text-gray-500"
      >
        {{ "No categories found" | translate }}
      </div>

      <div
        class="space-y-3"
        *ngIf="!categoriesLoading && filteredCategories.length > 0"
      >
        <!-- Parent categories and subcategories -->
        <div
          *ngFor="let category of filteredCategories; trackBy: trackByCategory"
          class="category-item"
        >
          <div class="flex items-center justify-between">
            <div
              class="flex cursor-pointer items-center gap-2"
              (click)="toggleCategory(category)"
            >
              <!-- Checkbox -->
              <div
                class="flex h-4 w-4 items-center justify-center rounded border"
                [ngClass]="{
                  'border-hover-color bg-hover-color': category.selected,
                  'border-gray-300': !category.selected,
                }"
              >
                <i
                  *ngIf="category.selected"
                  class="ri-check-line text-xs text-white"
                ></i>
              </div>

              <!-- Category name -->
              <span [ngClass]="{ 'text-hover-color': category.selected }">
                {{ category.name }}
              </span>
            </div>

            <!-- Expand/Collapse Icon for categories with subcategories -->
            <button
              *ngIf="
                category.isParent &&
                category.subcategories &&
                category.subcategories.length > 0
              "
              (click)="toggleCategoryExpansion(category, $event)"
              class="text-gray-500 hover:text-gray-700"
            >
              <i
                [class]="
                  isCategoryExpanded(category)
                    ? 'ri-arrow-up-s-line'
                    : 'ri-arrow-down-s-line'
                "
              ></i>
            </button>
          </div>

          <!-- Subcategories (indented) - shown only if expanded -->
          <div
            *ngIf="
              category.isParent &&
              category.subcategories &&
              category.subcategories.length > 0 &&
              isCategoryExpanded(category)
            "
            class="mt-2 flex flex-col gap-2 ps-6"
          >
            <div
              *ngFor="let subcategory of category.subcategories"
              class="category-item"
            >
              <div class="flex items-center justify-between">
                <div
                  class="flex cursor-pointer items-center gap-2"
                  (click)="toggleCategory(subcategory)"
                >
                  <!-- Subcategory checkbox -->
                  <div
                    class="flex h-4 w-4 items-center justify-center rounded border"
                    [ngClass]="{
                      'border-hover-color bg-hover-color': subcategory.selected,
                      'border-gray-300': !subcategory.selected,
                    }"
                  >
                    <i
                      *ngIf="subcategory.selected"
                      class="ri-check-line text-xs text-white"
                    ></i>
                  </div>

                  <!-- Subcategory name -->
                  <span
                    [ngClass]="{ 'text-hover-color': subcategory.selected }"
                  >
                    {{ subcategory.name }}
                  </span>
                </div>

                <!-- Expand/Collapse Icon for subcategories with sub-subcategories -->
                <button
                  *ngIf="
                    subcategory.isParent &&
                    subcategory.subcategories &&
                    subcategory.subcategories.length > 0
                  "
                  (click)="toggleSubCategoryExpansion(subcategory, $event)"
                  class="text-gray-500 hover:text-gray-700"
                >
                  <i
                    [class]="
                      isSubCategoryExpanded(subcategory)
                        ? 'ri-arrow-up-s-line'
                        : 'ri-arrow-down-s-line'
                    "
                  ></i>
                </button>
              </div>

              <!-- Sub-subcategories (double indented) - shown only if expanded -->
              <div
                *ngIf="
                  subcategory.isParent &&
                  subcategory.subcategories &&
                  subcategory.subcategories.length > 0 &&
                  isSubCategoryExpanded(subcategory)
                "
                class="mt-2 flex flex-col gap-2 ps-6"
              >
                <div
                  *ngFor="let subSubcategory of subcategory.subcategories"
                  class="flex cursor-pointer items-center gap-2"
                  (click)="toggleCategory(subSubcategory)"
                >
                  <!-- Sub-subcategory checkbox -->
                  <div
                    class="flex h-4 w-4 items-center justify-center rounded border"
                    [ngClass]="{
                      'border-hover-color bg-hover-color':
                        subSubcategory.selected,
                      'border-gray-300': !subSubcategory.selected,
                    }"
                  >
                    <i
                      *ngIf="subSubcategory.selected"
                      class="ri-check-line text-xs text-white"
                    ></i>
                  </div>

                  <!-- Sub-subcategory name -->
                  <span
                    [ngClass]="{ 'text-hover-color': subSubcategory.selected }"
                  >
                    {{ subSubcategory.name }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Brand -->
  <div class="border-t pb-2 pt-4">
    <div
      class="mb-4 flex cursor-pointer items-center justify-between"
      (click)="toggleFilter('brands')"
    >
      <h3 class="font-medium text-gray-800">
        {{ "collections.filterSidebar.brands" | translate }}
      </h3>
      <i
        [class]="showBrands ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"
      ></i>
    </div>

    <div *ngIf="showBrands">
      <div class="relative mb-4">
        <input
          type="text"
          placeholder="{{ 'Search' | translate }}"
          [(ngModel)]="brandSearchTerm"
          class="w-full rounded-md border bg-white px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-offset-hover-color"
        />
        <div class="absolute right-3 top-1/2 -translate-y-1/2 transform">
          <i *ngIf="!brandSearchTerm" class="ri-search-line text-gray-400"></i>
          <i
            *ngIf="brandSearchTerm"
            class="ri-close-line cursor-pointer text-gray-600 hover:text-gray-800"
            (click)="brandSearchTerm = ''"
          ></i>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div *ngIf="brandsLoading" class="flex justify-center py-4">
        <div
          class="h-6 w-6 animate-spin rounded-full border-2 border-t-2 border-hover-color"
        ></div>
      </div>

      <!-- Empty Brands -->
      <div
        *ngIf="!brandsLoading && filteredBrands.length === 0"
        class="py-4 text-center text-gray-500"
      >
        {{ "No brands found" | translate }}
      </div>

      <div
        class="space-y-3"
        *ngIf="!brandsLoading && filteredBrands.length > 0"
      >
        <div
          *ngFor="let brand of filteredBrands; trackBy: trackByBrand"
          class="flex cursor-pointer items-center"
          (click)="toggleBrand(brand)"
        >
          <!-- Checkbox -->
          <div
            class="mr-2 flex h-4 w-4 items-center justify-center rounded border"
            [ngClass]="{
              'border-hover-color bg-hover-color': brand.selected,
              'border-gray-300': !brand.selected,
            }"
          >
            <i
              *ngIf="brand.selected"
              class="ri-check-line text-xs text-white"
            ></i>
          </div>
          <span [ngClass]="{ 'text-hover-color': brand.selected }">
            {{
              languageService.getCurrentLanguage() === "ar" && brand.ar
                ? brand.ar
                : brand.en
            }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Filter -->
  <div class="border-t pb-2 pt-4">
    <div
      class="mb-4 flex cursor-pointer items-center justify-between"
      (click)="toggleFilter('ratings')"
    >
      <h3 class="font-medium text-gray-800">
        {{ "collections.filterSidebar.ratings" | translate }}
      </h3>
      <i
        [class]="showRatings ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"
      ></i>
    </div>

    <div *ngIf="showRatings" class="space-y-3">
      <div
        *ngFor="let rating of ratingOptions"
        class="flex cursor-pointer items-center"
        (click)="toggleRating(rating)"
      >
        <!-- Checkbox -->
        <div
          class="mr-2 flex h-4 w-4 items-center justify-center rounded border"
          [ngClass]="{
            'border-hover-color bg-hover-color': rating.selected,
            'border-gray-300': !rating.selected,
          }"
        >
          <i
            *ngIf="rating.selected"
            class="ri-check-line text-xs text-white"
          ></i>
        </div>
        <div class="flex items-center gap-2">
          <!-- Stars -->
          <div class="flex items-center gap-1">
            <ng-container *ngFor="let star of [1, 2, 3, 4, 5]">
              <i
                *ngIf="star <= rating.value"
                class="ri-star-fill text-yellow-400"
              ></i>
            </ng-container>
          </div>

          <!-- Rating Text -->
          <div class="flex items-center text-gray-700">
            <span class="mr-1">{{ rating.value }}</span>
            <span>{{ "collections.productCard.rating" | translate }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Price Filter -->
  <div class="border-t pb-2 pt-4">
    <div
      class="mb-4 flex cursor-pointer items-center justify-between"
      (click)="toggleFilter('price')"
    >
      <h3 class="font-medium text-gray-800">
        {{ "collections.filterSidebar.price" | translate }}
      </h3>
      <i
        [class]="showPrice ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"
      ></i>
    </div>

    <div *ngIf="showPrice" class="space-y-3">
      <!-- Price Range Options -->
      <div
        *ngFor="let priceRange of priceRanges"
        class="flex cursor-pointer items-center"
        (click)="selectPriceRange(priceRange)"
      >
        <!-- Checkbox -->
        <div
          class="mr-2 flex h-4 w-4 items-center justify-center rounded border"
          [ngClass]="{
            'border-hover-color bg-hover-color': priceRange.selected,
            'border-gray-300': !priceRange.selected,
          }"
        >
          <i
            *ngIf="priceRange.selected"
            class="ri-check-line text-xs text-white"
          ></i>
        </div>
        <span [ngClass]="{ 'text-hover-color': priceRange.selected }">
          <ng-container *ngIf="priceRange.max !== null">
            {{ priceRange.min }}-{{ priceRange.max }}
            {{ getLocalizedCurrency() }}
          </ng-container>
          <ng-container *ngIf="priceRange.max === null">
            {{ priceRange.min }}+ {{ getLocalizedCurrency() }}
          </ng-container>
        </span>
      </div>
    </div>
  </div>
</div>
